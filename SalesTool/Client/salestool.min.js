"use strict";var Enferno,enferno_salestool;(function(n){var t;(function(n){var t;(function(n){var t;(function(n){var u=function(){var n=this;n.getCulture=function(t,i){return n.cultureStrings[i]?n.cultureStrings[i][t]:n.cultureStrings.en[t]};n.cultureStrings={en:{Acknowledged:"Notified",Allocation:"Allocation",BackOrder:"Back order",Buyer:"Buyer",Cancel:"Cancel order",Cancelled:"Cancelled",ChangeTo:"Change to",Company:"Company",Confirmed:"Placed order",CreditControl:"Credit control",Customer:"Customer",CustomerOrders:"Customer orders",Date:"Date",DecimalSign:".",Delivered:"Delivered",DeliveryNote:"Delivery note",DeliveryNoteNotCreated:"Delivery note not created",Discount:"Discount",Email:"Email",ErpConfirmed:"Confirmed",Filter:"Filter",Invoiced:"Invoiced",Name:"Name",NotifyCheckedOrders:"Remind checked orders",NotifiedOrder:"Reminders has been sent to customer.",NotifiedOrders:"Reminders has been sent to checked orders.",NotPickedUp:"Not picked up",Order:"Order",OrderDate:"Order date",OrderNo:"Orderno.",Orders:"Orders",OrdersFor:"Orders for",ParcelCode:"Parcel code",PartlyDelivered:"Partly delivered",PartNo:"Partno.",Payment:"Payment",PickedUp:"Picked up",PickupOrders:"Pick up",CellPhone:"Cell phone",Price:"Price",Quantity:"Quantity",ReadyForPickup:"Ready for pickup",ReadyForReservation:"Ready for reservation",ReservationOrders:"Reservation",Reserved:"Reserved",SearchCustomer:"Search customer",SearchOrder:"Search order",SelectStore:"Select store...",Shipping:"Shipping",ShipTo:"Ship to",ShowAll:"Show all",Status:"Status",Store:"Store",ThousandSeparator:",",Total:"Total",UndeliveredOrders:"Undelivered orders for store",UndeliveredOrdersFor:"Undelivered orders for",Unknown:"Unknown",Vat:"VAT"},sv:{Acknowledged:"Meddelad",Allocation:"Plockas",BackOrder:"Restorder",Buyer:"Köpare",Cancel:"Avbeställ order",Cancelled:"Avbeställd",ChangeTo:"Ändra till",Company:"Företag",Confirmed:"Beställd",CreditControl:"Kreditkontroll",Customer:"Person",CustomerOrders:"Kundorder",Date:"Datum",DecimalSign:",",Delivered:"Levererad",DeliveryNote:"Följesedel",DeliveryNoteNotCreated:"Följesedel ej skapad",Discount:"Rabatt",Email:"E-post",ErpConfirmed:"Godkänd",Filter:"Filter",Invoiced:"Fakturerad",Name:"Namn",NotifyCheckedOrders:"Påminn markerade order",NotifiedOrder:"Påminnelser har skickats till kunden.",NotifiedOrders:"Påminnelser har skickats till markerade order.",NotPickedUp:"Återlämnad",Order:"Order",OrderDate:"Orderdatum",OrderNo:"Ordernr.",Orders:"Order",OrdersFor:"Order för",ParcelCode:"Kollinummer",PartlyDelivered:"Dellevererad",PartNo:"Art.nr",Payment:"Betalsätt",PickedUp:"Hämtad",PickupOrders:"Hämtas",CellPhone:"Mobiltelefon",Price:"Pris",Quantity:"Antal",ReadyForPickup:"Inlevererad",ReadyForReservation:"Ska reserveras",ReservationOrders:"Reservation",Reserved:"Reserverad",SearchCustomer:"Sök kund",SearchOrder:"Sök order",SelectStore:"Välj butik...",Shipping:"Leveranssätt",ShipTo:"Leverans",ShowAll:"Visa alla",Status:"Status",Store:"Butik",ThousandSeparator:" ",Total:"Totalt",UndeliveredOrders:"Olevererade order för butik",UndeliveredOrdersFor:"Olevererade order för",Unknown:"Okänd",Vat:"Moms"}}},t,i,r;n.Culture=u;t=function(n){var t=this;t.parent=n;t.list=ko.observableArray();t.searchText=ko.observable();t.searchTextDelay=ko.pureComputed(t.searchText).extend({rateLimit:{method:"notifyWhenChangesStop",timeout:400}});t.showList=ko.pureComputed(function(){return t.list().length>0},t);t.searchTextDelay.subscribe(function(){t.search()},this);t.searchEnter=function(n,i){if(i.keyCode!==13||t.list().length===0)return!0;n={Id:t.list()[0].Id};t.set(n)};t.search=function(){var n=t.searchText();if(n.length<3){t.list([]);return}n!==t.parent.salesTool.CustomerName()&&(t.parent.isLoading(!0),$.get("/api/salestool/customer/search/"+n).done(function(n){t.list(n);t.parent.setAutoClose(event)}).fail(function(n){t.parent.showError(n)}).complete(function(){t.parent.isLoading(!1)}))};t.set=function(n){t.parent.closeWindows();t.parent.isLoading(!0);$.ajax({url:"/api/salestool/customer/set/"+n.Id,type:"PUT"}).done(function(n){t.parent.dataBind(n)}).fail(function(n){t.parent.showError(n)}).complete(function(){t.parent.isLoading(!1)})};t.clear=function(){t.searchText(null);t.parent.closeWindows();t.parent.hasCustomer()&&(t.parent.isLoading(!0),$.ajax({url:"/api/salestool/customer/clear",type:"PUT"}).done(function(n){t.parent.dataBind(n)}).fail(function(n){t.parent.showError(n)}).complete(function(){t.parent.isLoading(!1)}))}};n.Customer=t;i=function(n){var t=this,i=function(n){return t.filter()==="ShowAll"?!0:t.compareStatus(n.Status,t.filter())};t.parent=n;t.showMenu=ko.observable(!1);t.searchText=ko.observable();t.list=ko.pureComputed(function(){return t.showStoreList()?t.unfilteredStoreList().filter(i):t.unfilteredList().filter(i)},t);t.unfilteredList=ko.observableArray([]);t.unfilteredStoreList=ko.observableArray([]);t.loadedStore=0;t.pickUpCount=ko.pureComputed(function(){return t.unfilteredStoreList().filter(function(n){return t.compareStatus(n.Status,"Confirmed")}).length},t);t.reservationCount=ko.pureComputed(function(){return t.unfilteredStoreList().filter(function(n){return t.compareStatus(n.Status,"ReadyForReservation")}).length},t);t.showStoreList=ko.observable(!1);t.filter=ko.observable("Confirmed");t.showFilter=ko.observable(!1);t.filterLabel=ko.pureComputed(function(){return t.parent.getCulture("Filter")+(t.filter()?": "+t.parent.getCulture(t.filter()):"")},t);t.showList=ko.pureComputed(function(){return(t.showStoreList()?t.unfilteredStoreList().length:t.unfilteredList().length)>0&&t.order()==null},t);t.order=ko.observable();t.header=ko.observable();t.itemHeader=ko.observable();t.toggleMenu=function(n,i){t.showMenu()||t.parent.setAutoClose(i);t.showMenu(!t.showMenu())};t.getList=function(n,i){t.header(t.parent.getCulture("OrdersFor")+" "+t.parent.salesTool.CustomerName());t.filter("ShowAll");t.parent.closeWindows();t.parent.isLoading(!0);t.parent.preventBubble(n,i);t.showStoreList(!1);$.get("/api/salestool/order/list").done(function(n){t.unfilteredList(n)}).fail(function(n){t.parent.showError(n)}).complete(function(){t.parent.isLoading(!1)})};t.getPickupList=function(n,i){t.header(t.parent.getCulture("OrdersFor")+" "+t.parent.salesTool.StoreName());t.filter("Confirmed");t.parent.closeWindows();t.parent.preventBubble(n,i);t.loadStoreList()};t.getReservationList=function(n,i){t.header(t.parent.getCulture("OrdersFor")+" "+t.parent.salesTool.StoreName());t.filter("ReadyForReservation");t.parent.closeWindows();t.parent.preventBubble(n,i);t.loadStoreList()};t.loadStoreList=function(){(t.showStoreList(!0),t.loadedStore!=t.parent.salesTool.StoreId())&&t.parent.isLoading(!0)};t.loadStoreListImpl=function(){$.get("/api/salestool/order/liststore").done(function(n){t.unfilteredStoreList(n);t.loadedStore=t.parent.salesTool.StoreId()}).fail(function(n){t.parent.showError(n)}).complete(function(){t.parent.isLoading(!1)})};t.searchEnter=function(n,i){if(i.keyCode!=13||t.searchText().length<3)return!0;t.search()};t.search=function(){t.parent.isLoading(!0);$.get("/api/salestool/order/search/"+t.searchText()).done(function(n){t.setOrder(n)}).fail(function(n){t.parent.showError(n)}).complete(function(){t.parent.isLoading(!1)})};t.set=function(n){t.itemHeader(t.parent.getCulture("Order")+" "+n.OrderNumber);t.parent.preventBubble(n,event);t.parent.isLoading(!0);$.get("/api/salestool/order/get/"+n.OrderNumber).done(function(n){t.setOrder(n)}).fail(function(n){t.parent.showError(n)}).complete(function(){t.parent.isLoading(!1)})};t.setOrder=function(n){t.order(n)};t.close=function(){t.order(null)};t.toggleFilter=function(){t.showFilter(!t.showFilter())};t.setFilter=function(n){t.filter(n);t.showFilter(!1)};t.getChangeToLabel=function(i){var r=t.getNextStatus(i);return r!=null?n.getCulture("ChangeTo")+" "+n.getCulture(r):null};t.compareStatus=function(n,t){if(n==t)return!0;switch(n){case"ErpConfirmed":case"Invoiced":case"PartlyDelivered":return t=="Confirmed";case"Acknowledged":case"NotPickedUp":return t=="ReadyForPickup"}return!1};t.getNextStatus=function(n){switch(n){case"Confirmed":case"ErpConfirmed":case"Invoiced":case"PartlyDelivered":return"ReadyForPickup";case"ReadyForPickup":case"Acknowledged":case"NotPickedUp":return"PickedUp";case"PickedUp":return"Delivered";case"ReadyForReservation":return"Reserved";case"Reserved":return"Delivered";case"Delivered":case"Cancelled":return"ReadyForPickup"}return null};t.changeDeliveryNoteStatus=function(n){t.setStatus(n,t.getNextStatus(n.Status))};t.cancel=function(n){t.setStatus(n,"Cancelled")};t.setStatus=function(n,i){if(t.parent.isLoading())return!1;t.parent.isLoading(!0);n.Status=i;$.ajax({url:"/api/salestool/order/updatedeliverynotestatus",type:"PUT",data:JSON.stringify(n),contentType:"application/json"}).done(function(n){t.order(n)}).fail(function(n){t.parent.showError(n)}).complete(function(){t.parent.isLoading(!1)})};t.notifyCheckedOrders=function(){if(t.parent.isLoading())return!1;t.parent.isLoading(!0);$.ajax({url:"/api/salestool/order/notifycheckedorders",type:"PUT",data:JSON.stringify(t.unfilteredList()),contentType:"application/json"}).done(function(n){t.unfilteredList(n);t.parent.showMessage(t.parent.getCulture("NotifiedOrders"))}).fail(function(n){t.parent.showError(n)}).complete(function(){t.parent.isLoading(!1)})};t.notify=function(){if(t.parent.isLoading())return!1;t.parent.isLoading(!0);$.ajax({url:"/api/salestool/order/notifycheckedorder",type:"PUT",data:JSON.stringify(t.order()),contentType:"application/json"}).done(function(){t.parent.showMessage(t.parent.getCulture("NotifiedOrder"))}).fail(function(n){t.parent.showError(n)}).complete(function(){t.parent.isLoading(!1)})};t.print=function(){if(t.parent.isLoading())return!1;t.parent.isLoading(!0);$.get("/api/salestool/order/print/"+t.order().OrderNumber).done(function(n){$("#sales-tool-print").contents().find("body").html(n);$("#sales-tool-print").get(0).contentWindow.print()}).fail(function(n){t.parent.showError(n)}).complete(function(){t.parent.isLoading(!1)})};t.loadStoreListImpl();window.setInterval(function(){t.loadStoreListImpl()},3e5)};n.Order=i;r=function(){var t=this;t.salesTool=null;t.isLoading=ko.observable(!0);t.isLoaded=ko.observable(!1);t.showAccount=ko.observable(!1);t.culture=new n.Culture;t.customer=new n.Customer(t);t.order=new n.Order(t);t.stores=ko.observableArray();t.hasCustomer=ko.pureComputed(function(){return t.salesTool!=null?t.salesTool.CustomerId()>0:!1});t.hasStore=ko.pureComputed(function(){return t.salesTool!=null?t.salesTool.StoreId()>0:!1});t.ticks=0;t.dataBind=function(n){t.salesTool==null?t.salesTool=ko.mapping.fromJS(n):ko.mapping.fromJS(n,t.salesTool);t.closeWindows()};t.toggleAccount=function(n,i){t.showAccount()||t.setAutoClose(i);t.showAccount(!t.showAccount())};t.selectStore=function(n,i){i.timeStamp-t.ticks>1e3&&(t.setAutoClose(i),$.get("/api/salestool/liststores").done(function(n){t.stores(n)}).fail(function(n){t.showError(n)}))};t.setStore=function(n,i){t.ticks=i.timeStamp;t.closeWindows();t.isLoading(!0);$.post("/api/salestool/setstore",{"":n.Id}).done(function(n){t.dataBind(n)}).fail(function(n){t.showError(n)})};t.format=function(n){for(var f=String(n).split("."),i=f[0],r=f.length>1?f[1]:"00",u=i.length-3;u>0;)i=[i.slice(0,u),t.getCulture("ThousandSeparator"),i.slice(u)].join(""),u-=3;return r=r.length==1?r+"0":r.substr(0,2),i+t.getCulture("DecimalSign")+r};t.getCulture=function(n){return t.culture.getCulture(n,t.salesTool?t.salesTool.CultureCode():"en")};t.showMessage=function(n){t.isLoading(!1);alert(n)};t.showError=function(n){t.isLoading(!1);alert(n.responseText)};t.closeWindows=function(){$("html").off("click");t.customer.list([]);t.showAccount(!1);t.stores([]);t.order.showMenu(!1);t.order.unfilteredList([]);t.order.showStoreList(!1);t.order.order(null);t.order.searchText(null);t.order.showFilter(!1);t.customer.searchText(t.salesTool.CustomerName());t.isLoading(!1)};t.preventBubble=function(n,t){t.cancelBubble=!0;t.stopPropagation&&t.stopPropagation()};t.setAutoClose=function(n){$("html").one("click",function(){enferno_salestool.closeWindows()});n.stopPropagation()};$.get("/api/salestool/get").done(function(n){n!=null?(t.dataBind(n),ko.applyBindings(t,$("#sales-tool")[0]),t.isLoaded(!0)):$("#sales-tool").hide()}).fail(function(n){t.showError(n)})};n.Main=r})(t=n.SalesTool||(n.SalesTool={}))})(t=n.Web||(n.Web={}))})(t=n.Public||(n.Public={}))})(Enferno||(Enferno={}));ko.bindingHandlers.stopBubble={init:function(n){ko.utils.registerEventHandler(n,"click",function(n){n.cancelBubble=!0;n.stopPropagation&&n.stopPropagation()})}};$(document).ready(function(){enferno_salestool=new Enferno.Public.Web.SalesTool.Main});